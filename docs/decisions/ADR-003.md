# ADR-003: Métrica-Norte e Eventos de Conversão

- **Status**: Accepted
- **Context Timestamp**: 2025-10-12

## Contexto
O MVP precisa medir sucesso pelo volume de atendimentos que chegam a um “pedido de orçamento” e pela velocidade de resposta inicial (TTFR). Atualmente recebemos eventos da Evolution API (mensagens) e teremos consumidores RabbitMQ para métricas. Precisamos padronizar:
- Definição da métrica-norte (North Star Metric) para orientar backlog e relatórios.
- Eventos mínimos registrados em banco/fila para calcular TTFR, taxa de conversão, valor do lead.
- Regras de deduplicação e janelas de tempo (conversas, sessões de atendimento).

## Fatores de decisão
- Métrica deve refletir impacto direto no funil comercial.
- Eventos precisam ser simples de capturar com a infraestrutura atual (Evolution API + RabbitMQ + Postgres).
- Deve permitir auditoria e reprocessamento (idempotência e dados suficientes).
- Alinhar com metas do negócio (pedidos qualificados, tempo de resposta).

## Opções consideradas
1. **North Star = Pedidos de orçamento qualificados por semana** com eventos granulares (`message_received`, `first_response`, `quote_requested`, `quote_sent`).  
   - Prós: foca diretamente na meta comercial; eventos reutilizáveis para outras métricas.  
   - Contras: exige classificação automática de intenção “pedido de orçamento”; risco de falso positivo.  
   - Impacto: custo baixo (processamento no mesmo stack), manutenção moderada (modelos de intenção).
2. **North Star = Conversas concluídas com satisfação >= X** via survey ou tags manuais.  
   - Prós: mede experiência; pode ser capturado após atendimento.  
   - Contras: depende de feedback explícito; não reflete impacto financeiro imediato.  
   - Impacto: custo médio (capturar survey); manutenção alta (coletar respostas).
3. **North Star = MQLs gerados** (lead qualificado pelo time) com eventos `lead_scored`.  
   - Prós: compatível com pipelines de marketing.  
   - Contras: precisa integração com CRM/Human-in-the-loop; pode atrasar medição.  
   - Impacto: custo médio; manutenção elevada (sincronização com CRM).

## Decisão
Adotamos a opção 1: a métrica-norte é **Pedidos de orçamento qualificados por semana**. Definimos os eventos-padrão:
- `message_received`: cada mensagem inbound com `conversation_id`, `lead_id`, `channel`, `timestamp`.
- `first_response`: primeira saída da IA/humano após `message_received`; usado para TTFR (`first_response.timestamp - first_message.timestamp`).
- `quote_intent_detected`: evento gerado quando modelo de intenção/roteiro identifica pedido de orçamento (confiança >= 0.8).
- `quote_request_confirmed`: confirmação explícita (ex.: usuário envia dados de orçamento) — consolida a conversão.
- `quote_sent`: quando integração dispara orçamento para o lead (opcional para métricas downstream).

TTFR será medido ao nível de conversa: diferença entre o primeiro `message_received` do lead e o `first_response` correspondente. Conversas expiram após 30 minutos de inatividade; novos contatos reabrem com novo `conversation_id`.

## Consequências
- Positivo: Métrica diretamente ligada à receita; pode alimentar dashboards semanais.  
- Positivo: Eventos reutilizáveis para outras métricas (taxa de resposta, valor estimado do lead).  
- Risco: detecção de intenção depende de modelo/roteiro; erros impactam contagem de conversões.  
- Mitigação: manter amostra revisada manualmente (curadoria) e ajustar limiar de confiança periodicamente.

## Follow-up
- [ ] Implementar consumidor RabbitMQ `insights-kpi` armazenando eventos em `fact_conversation` e `fact_conversion`.  
- [ ] Treinar/ajustar classificador de intenção “pedido de orçamento” com threshold inicial 0.8; registrar métricas de precisão.  
- [ ] Criar dashboard semanal com `quote_request_confirmed` e TTFR médio/p95.  
- [ ] Documentar procedimento de curadoria manual e ajuste de limiar.
