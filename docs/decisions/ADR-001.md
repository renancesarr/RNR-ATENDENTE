# ADR-001: Política de Segredos e Distribuição de Credenciais

- **Status**: Accepted
- **Context Timestamp**: 2025-10-12

## Contexto
O MVP demanda integrações com Evolution API, OpenAI, Postgres, Redis e RabbitMQ. Precisamos definir uma política clara para criação, armazenamento, rotação e compartilhamento de segredos desde o início para evitar vazamentos (ex.: `.env` versionado, chaves expostas em chats). Também devemos orientar o uso de GitHub Actions (workflow IA Guard) e pipelines futuros.

## Fatores de decisão
- Minimizar risco de vazamento e impacto em provedores externos.
- Aderir ao fluxo de desenvolvimento atual (docker-compose, repositório GitHub, automações IA).
- Garantir que a equipe consiga operar segredos com baixo atrito e plano de rotação periódico.

## Opções consideradas
1. **HashiCorp Vault (self-hosted ou gerenciado) + GitHub Secrets**  
   - Prós: controle centralizado, suporte a políticas, auditoria e geração dinâmica; integrações amplas.  
   - Contras: exige setup/operacionalização do Vault; curva de aprendizado inicial.  
   - Impacto: custo moderado (se self-hosted no mesmo host), latência desprezível; manutenção requer playbooks.
2. **GitHub Secrets + distribuição manual de `.env` via 1Password/Signal**  
   - Prós: fácil de iniciar, sem infraestrutura adicional.  
   - Contras: risco humano (envio por canais errados), ausência de auditoria/rotação central, pouca automação.  
   - Impacto: custo baixo, mas manutenção manual e suscetível a erros.
3. **Secrets Manager do provedor cloud (AWS/GCP/Azure) + GitHub Secrets**  
   - Prós: serviço gerenciado, auditoria nativa, integração com workloads.  
   - Contras: requer acoplamento à cloud escolhida; MVP ainda roda on-prem/compose.  
   - Impacto: custo mensal adicional; latência mínima; manutenção delegada ao provedor.

## Decisão
Adotamos **HashiCorp Vault como cofre central** para ambientes não-prod e prod, mantendo **GitHub Secrets** apenas para variáveis necessárias a workflows. O Vault será exposto via TLS, autenticado por token AppRole. Scripts de bootstrap gerarão `.env` locais a partir do Vault (nunca versionados). É proibido compartilhar segredos por e-mail, mensagens abertas ou anexos; só é permitido via Vault ou canal criptografado aprovado (ex.: 1Password Secure Note temporária).

## Consequências
- Positivo: auditoria e rotação centralizada; segregação de responsabilidades entre Vault (runtime) e GitHub Secrets (CI).  
- Positivo: redução de risco de vazamento acidental via repositório.  
- Risco: demanda operacional para manter Vault (backup de storage, atualização de certificados).  
- Mitigação: automatizar backup diário do Vault e documentar playbook de recuperação; revisar usuários/roles trimestralmente.

## Follow-up
- [ ] Provisionar instância Vault (dev mode apenas local; prod com storage backend persistente).  
- [ ] Criar AppRoles por serviço (api, workers, pipelines) e definir TTL/renovação.  
- [ ] Documentar checklist de rotação de segredos e anexar a `docs/scrum-master/`.  
- [ ] Popular GitHub Secrets mínimos (`OPENAI_API_KEY`, `VAULT_ADDR`, `VAULT_ROLE_ID`, etc.) com placeholders até termos valores finais.
