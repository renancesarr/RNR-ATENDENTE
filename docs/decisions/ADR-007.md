# ADR-007: pgvector vs Serviço Vetorial Gerenciado

- **Status**: Draft
- **Context Timestamp**: 2025-10-13

## Contexto
Estamos usando `pgvector` no mesmo Postgres operacional (ADR-20251012-vector-store-strategy). Em fases futuras, volume de embeddings ou requisitos de SLA podem exigir serviço dedicado (Pinecone, Weaviate, etc.). Precisamos formalizar comparação e critérios para migração.

## Opções consideradas
1. **Manter pgvector no Postgres atual**
   - **Prós**: custo baixo (infra já existente), transações ACID unificadas, backup centralizado, menor complexidade operacional.
   - **Contras**: compartilhamento de recursos OLTP/OLAP, tuning manual (índices IVFFlat, manutenção `ANALYZE`), escalabilidade vertical limitada.
2. **Postgres dedicado com pgvector (cluster separado)**
   - **Prós**: isolamento de workload vetorial, reaproveita conhecimento pgvector, migração incremental.
   - **Contras**: custo adicional (novo host), replicação/ETL adicionais, backups separados.
3. **Serviço vetorial gerenciado (Pinecone, Weaviate Cloud, Qdrant Cloud)**
   - **Prós**: escalabilidade horizontal, métricas prontas, tuning automático, suporte a filtros avançados, SLAs de disponibilidade.
   - **Contras**: custo recorrente imediato (planos a partir de USD 150–300/mês), dependência externa, latência de rede extra, esforço de integração/auth.

## Avaliação
| Critério | pgvector atual | pgvector dedicado | Serviço gerenciado |
| --- | --- | --- | --- |
| **Custo** | + | ± | −− |
| **Menor latência** | + | + | ± |
| **Escalabilidade** | − | ± | + |
| **Operação (DevOps)** | + | ± | + |
| **Tuning/observabilidade** | − | ± | + |

## Decisão
Para o MVP e piloto, **manter pgvector no Postgres atual**. Reavaliar quando qualquer critério abaixo ocorrer:
- >1 milhão de embeddings ou crescimento > 10% por semana.
- Latência de busca média > 150 ms apesar de tuning (`lists`, `ANALYZE`).
- Necessidade de replicação global ou multi-tenant isolado.

## Consequências
- Positivo: sem custo extra e simplicidade operacional.
- Positivo: facilidade para joins com dados relacionais.
- Risco: saturação de recursos Postgres; monitoramento obrigatório.
- Mitigação: métricas de CPU/IO, limites de queries, planejar cluster dedicado (opção 2) como primeiro passo antes de migrar para serviço gerenciado.

## Follow-up
- [ ] Criar dashboard de latência/uso de pgvector (consultas, tamanho dos índices).
- [ ] Preparar plano de migração incremental (dump/load embeddings) caso trigger de reavaliação ocorra.
- [ ] Orçar serviços gerenciados (Pinecone/Weaviate) para comparação precisa quando necessário.
