# ADR-005: Política de Retenção e Anonimização de Dados

- **Status**: Accepted
- **Context Timestamp**: 2025-10-13

## Contexto
O chatbot manipula dados pessoais (telefone, nome, mensagens, anexos) e precisa cumprir requisitos de privacidade (LGPD) desde o MVP. Já definimos métrica-norte, eventos de conversão e armazenamento em Postgres/pgvector (ADR-000/002/003). Agora é necessário estabelecer:
- Períodos padrão de retenção para conversas, anexos, logs e métricas.
- Regras de anonimização/parcialização (PII) antes da expiração completa.
- Mecanismos para exceções (ex.: leads em negociação ativa) e auditoria.
- Parâmetros configuráveis para ambientes (dev, staging, prod).

## Fatores de decisão
- Atender requisitos mínimos de privacidade sem inviabilizar métricas e RAG.
- Manter custos de armazenamento sob controle.
- Permitir auditoria e rastreabilidade quando houver solicitações legais.
- Evitar bloqueios no fluxo de dados para IA (RAG) e KPIs.

## Opções consideradas
1. **Política em duas camadas (anonimização parcial + deleção definitiva)** com parametrização por tenant.  
   - Prós: cumpre requisitos de minimização; mantém indicadores agregados; flexível.  
   - Contras: demanda implementação de jobs e flags por registro.  
   - Impacto: custo moderado; manutenção média (monitorar jobs).
2. **Deleção definitiva após N dias sem etapa de anonimização**.  
   - Prós: simples; reduz risco de vazamento.  
   - Contras: perde rastreabilidade para métricas/RAG; pode conflitar com auditorias.  
   - Impacto: custo baixo mas compromete analítica.
3. **Retenção ilimitada com criptografia forte**.  
   - Prós: preserva histórico completo; útil para analytics.  
   - Contras: não cumpre princípios de minimização; alto risco/regulatório.  
   - Impacto: custo alto; manutenção elevada.

## Decisão
Adotamos a opção 1: política em duas camadas com parâmetros configuráveis:
- **Retenção quente (dados brutos)**: mensagens, anexos e metadados permanecem íntegros por 180 dias em produção (60 dias em staging, 30 em dev). Após esse período, PII sensível (telefone, nome, campos livres) é pseudonimizada (hash irreversível + sal) e o conteúdo textual é truncado a tags e intenções. Anexos são excluídos.
- **Retenção fria (dados anonimizados)**: registros anonimizados são mantidos por mais 12 meses para métricas agregadas e auditoria de modelos. Expirado esse prazo, ocorre deleção definitiva.
- **Exceções**: leads com status “negociação ativa” podem estender retenção quente em até 90 dias adicionais; a justificativa fica registrada em `audit_retention`.
- **Parâmetros**: valores configuráveis via tabela `bot_config` (colunas `retention_hot_days`, `retention_anonymized_days`, `retention_exception_days`) e variáveis de ambiente para scripts batch.
- **Anonimização**: utiliza função `anon.hash_phone(phone, salt)` e mascaramento de campos textuais (`anon.partial_mask`). Conversas convertidas em embeddings para RAG permanecem, mas são reindexadas sem PII (usando IDs sintéticos).

## Consequências
- Positivo: cumpre requisitos de minimização mantendo capacidade analítica e de RAG.  
- Positivo: configurações por ambiente/tenant permitem adequar a políticas locais.  
- Risco: implementação depende de jobs confiáveis (anonimização, deleção); falha pode gerar inconformidade.  
- Mitigação: monitorar jobs via métricas e alertas; registrar execuções na tabela `audit_retention_log`; auditoria trimestral.

## Follow-up
- [ ] Implementar tabela `audit_retention` e `audit_retention_log` com estados da retenção.  
- [ ] Criar job diário `anonimize_expired_records` (Postgres ou worker) aplicando pseudonimização e removendo anexos.  
- [ ] Criar job mensal `purge_anonymized_records` eliminando dados após período frio.  
- [ ] Incluir testes automatizados verificando que PII não permanece após deadlines.  
- [ ] Documentar procedimento de exceções e aprovação em `docs/scrum-master/`.
